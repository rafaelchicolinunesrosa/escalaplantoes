<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Escala de Fiscaliza√ß√£o DEMUTRAN Osasco</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --gap:14px;
      --border-color:#cfcfe6;
    }

    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f6f6f6;
    }

    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 16px #ccc;
    }

    .logos {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 12px;
    }
    .logos img { height: 58px; object-fit: contain; }

    h1 { text-align: center; font-size: 1.5rem; margin: 4px 0 8px; }

    /* Se√ß√£o de configura√ß√£o do GitHub */
    .github-config {
      background: #fff3cd; 
      border: 2px solid #ffc107; 
      border-radius: 8px;
      padding: 12px 15px; 
      margin-bottom: 15px; 
      font-size: 0.90rem;
    }
    .github-config h3 { 
      color: #856404; 
      margin: 0 0 10px 0; 
      font-size: 1.1rem;
    }
    .github-config label { 
      font-weight: bold; 
      display: block; 
      margin-top: 8px;
      color: #856404;
    }
    .github-config input { 
      width: 100%; 
      padding: 8px; 
      margin-top: 4px; 
      border: 1px solid #ffc107;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .github-config button {
      background: #28a745; 
      color: #fff; 
      border: none; 
      padding: 8px 16px; 
      border-radius: 5px;
      cursor: pointer; 
      font-size: 0.9rem;
      margin-top: 10px;
    }
    .github-config button:hover {
      background: #218838;
    }
    .github-config .status {
      margin-top: 10px;
      padding: 8px;
      border-radius: 4px;
      display: none;
    }
    .github-config .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .github-config .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .info-template {
      background: #e7f3ff; 
      border: 1px solid #0070c0; 
      border-radius: 8px;
      padding: 10px 12px; 
      margin-bottom: 12px; 
      font-size: 0.90rem;
    }
    .info-template strong { color: #004080; }
    .info-template ul { margin: 6px 0; padding-left: 20px; }
    .info-template li { margin: 3px 0; }

    .dados-gerais {
      display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px; font-size: 0.95rem;
    }
    .dados-gerais label { font-weight: bold; margin-right: 6px; }
    .dados-gerais input, .dados-gerais select { padding: 6px 8px; font-size: 0.95rem; margin-bottom: 6px; }

    .turnos-selector {
      background: #f1f6ff; border: 1px solid #c9dcff; border-radius: 8px;
      padding: 8px 10px; margin-bottom: 10px; font-size: 0.95rem;
    }
    .turnos-selector-title { font-weight: bold; color: #004080; margin-bottom: 4px; }
    .turnos-selector .opt {
      display: inline-flex; align-items: center; gap: 6px; margin: 4px 8px 4px 0;
      background: #fff; border: 1px solid #dde6ff; border-radius: 6px; padding: 2px 8px; user-select: none;
    }

    #turnosContainer { display: grid; grid-template-columns: 1fr 1fr; gap: var(--gap); align-items: start; }
    .turno-card { border: 1px solid #eee; border-radius: 10px; padding: 10px; background: #fcfcff; }
    .turno-title { font-size: 1.02rem; margin-bottom: 6px; color: #004080; font-weight: bold; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 6px;
      background: #fafafa;
      font-size: 0.9rem;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid var(--border-color);
      padding: 4px 3px;
      text-align: left;
      vertical-align: top;
      word-wrap: break-word;
      line-height: 1.2;
    }
    th { background: #eef0ff; font-weight: 600; }

    th.col-viatura, td.col-viatura { width: 60px; }
    th.col-36,     td.col-36       { width: 72px; }
    th.col-agentes,td.col-agentes  { width: 130px; }
    th.col-os,     td.col-os       { width: auto; }
    th.col-acao,   td.col-acao     { width: 64px; }

    .add-row-btn {
      background: #0070c0; color: #fff; border: none; padding: 6px 10px; border-radius: 5px;
      cursor: pointer; font-size: 0.88rem;
    }
    .remove-row-btn {
      background: #c00; color: #fff; border: none; padding: 2px 8px; border-radius: 5px;
      cursor: pointer; font-size: 0.82rem;
    }

    .observacoes-section { margin-top: 10px; border-top: 2px solid #eee; padding-top: 8px; }
    .observacoes-section textarea {
      width: 100%;
      min-height: 70px;
      padding: 7px;
      font-size: 0.95rem;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      background: #fff;
      resize: both;
    }

    .assinatura-section { margin-top: 12px; border-top: 2px solid #eee; padding-top: 8px; }
    .assinatura-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: end; }

    .linha-assinatura {
      margin: 16px auto 0 auto;
      width: 40%;
      border-top: 1px solid #000;
      text-align: center;
      padding-top: 4px;
      font-size: 0.92rem;
    }

    .print-btn {
      display: block; margin: 16px auto 8px auto; padding: 9px 16px; background: #004080; color: #fff;
      border: none; border-radius: 7px; font-size: 1rem; cursor: pointer;
    }

    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.8);
      color: white;
      padding: 20px 40px;
      border-radius: 10px;
      z-index: 10000;
      font-size: 1.1rem;
    }

    @media (max-width: 1000px) { #turnosContainer { grid-template-columns: 1fr; } }

    td input[type="text"], td textarea {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid var(--border-color);
      background: #fff;
      padding: 6px 6px;
      resize: both;
      min-height: 36px;
      font-size: 0.92rem;
      line-height: 1.2;
    }
    textarea.auto-grow { overflow: auto; min-height: 52px; }

    @media print {
      .dados-gerais div { display: inline-block !important; }
      #supervisor { white-space: nowrap !important; width: auto !important; display: inline; }
      
      body, .container { background: #fff !important; padding: 0 !important; margin: 0 !important; }
      .container { box-shadow: none !important; border-radius: 0 !important; }

      @page { size: landscape; margin: 5mm; }

      .logos { margin-bottom: 4px; }
      h1 { margin: 2px 0 4px; }

      .add-row-btn, .remove-row-btn, .print-btn, .turnos-selector { display: none !important; }
      .info-template, .github-config { display: none !important; }

      #turnosContainer { grid-template-columns: 1fr 1fr !important; gap: 6px !important; page-break-inside: avoid; }
      .turno-card { page-break-inside: avoid; }

      table, th, td {
        border: 1px solid #000 !important;
        border-collapse: collapse !important;
      }

      th.col-acao, td.col-acao { display: none !important; }

      table { font-size: 0.80rem !important; }
      th, td {
        padding: 0 2px !important;
        line-height: 0.9 !important;
      }

      input[type="text"],
      textarea {
        background: transparent !important;
        border: none !important;
        padding: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        outline: none !important;
        width: 100% !important;
        display: inline-block !important;
        white-space: pre-wrap !important;
        overflow: visible !important;
        resize: none !important;
      }

      tbody textarea {
        min-height: 0 !important;
        max-height: none !important;
      }
      .observacoes-section textarea {
        min-height: 0 !important;
        max-height: none !important;
        margin-bottom: 0 !important;
        padding: 0 !important;
      }

      .assinatura-section { border-top: none; padding-top: 0; margin-top: 8px; }
      .linha-assinatura {
        width: 30% !important;
        border-top: 1px solid #000 !important;
        margin: 12px auto 0 auto !important;
        padding-top: 3px !important;
      }
    }
  </style>
</head>
<body>
  <div class="loading" id="loadingIndicator">Processando...</div>

  <div class="container">
    <div class="logos">
      <img src="logos/Logo demutran osasco.png" alt="Logo DEMUTRAN Osasco">
      <img src="logos/logo agente de transito.png" alt="Logo Agente de Tr√¢nsito">
    </div>

    <h1>Escala de Fiscaliza√ß√£o - DEMUTRAN Osasco</h1>

    <!-- Se√ß√£o de Configura√ß√£o do GitHub -->
    <div class="github-config" id="githubConfig">
      <h3>‚öôÔ∏è Configura√ß√£o do GitHub (Primeiro Acesso)</h3>
      <label for="githubToken">Token de Acesso (PAT):</label>
      <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
      
      <label for="githubOwner">Propriet√°rio do Reposit√≥rio:</label>
      <input type="text" id="githubOwner" placeholder="ex: demutran-osasco">
      
      <label for="githubRepo">Nome do Reposit√≥rio:</label>
      <input type="text" id="githubRepo" placeholder="ex: escalas-plantao">
      
      <button onclick="saveGitHubConfig()">üíæ Salvar Configura√ß√£o</button>
      <button onclick="testGitHubConnection()" style="background: #0070c0;">üîç Testar Conex√£o</button>
      
      <div class="status" id="configStatus"></div>
    </div>

    <div class="info-template">
      <strong>üí° Como usar o sistema com GitHub:</strong>
      <ul>
        <li><strong>Configura√ß√£o Inicial:</strong> Configure o GitHub uma √∫nica vez com seu token de acesso.</li>
        <li><strong>Salvamento Autom√°tico:</strong> Cada plant√£o salva em sua pr√≥pria pasta, sem conflitos entre supervisores.</li>
        <li><strong>Acesso de Qualquer Lugar:</strong> Suas escalas ficam salvas no GitHub, acess√≠veis de qualquer computador.</li>
        <li><strong>Hist√≥rico Completo:</strong> Todas as vers√µes das escalas s√£o mantidas no GitHub.</li>
      </ul>
    </div>

    <form id="escalaForm">
      <div class="dados-gerais">
        <div>
          <label for="data">Data:</label>
          <input type="date" id="data" name="data" required>
        </div>
        <div>
          <label for="diaSemana">Dia da Semana:</label>
          <select id="diaSemana" name="diaSemana" required>
            <option value="">Selecione...</option>
            <option value="Segunda-feira">Segunda-feira</option>
            <option value="Ter√ßa-feira">Ter√ßa-feira</option>
            <option value="Quarta-feira">Quarta-feira</option>
            <option value="Quinta-feira">Quinta-feira</option>
            <option value="Sexta-feira">Sexta-feira</option>
            <option value="S√°bado">S√°bado</option>
            <option value="Domingo">Domingo</option>
          </select>
        </div>
        <div>
          <label for="tipoOperacao">Plant√£o:</label>
          <select id="tipoOperacao" name="tipoOperacao" required>
            <option value="">Selecione...</option>
            <option value="Plant√£o A">Plant√£o A</option>
            <option value="Plant√£o B">Plant√£o B</option>
            <option value="Plant√£o C">Plant√£o C</option>
            <option value="Plant√£o D">Plant√£o D</option>
          </select>
        </div>
        <div>
          <label for="supervisor">Supervisor do Plant√£o:</label>
          <input type="text" id="supervisor" name="supervisor" required>
        </div>
      </div>

      <div class="turnos-selector" id="turnosSelector">
        <div class="turnos-selector-title">Selecionar Turnos para exibir:</div>
      </div>

      <div id="turnosContainer"></div>

      <div class="observacoes-section">
        <label for="observacoes"><strong>Observa√ß√µes Gerais:</strong></label><br>
        <textarea id="observacoes" name="observacoes" class="auto-grow" rows="3" placeholder="Anota√ß√µes gerais do dia, intercorr√™ncias, orienta√ß√µes..."></textarea>
      </div>

      <div class="assinatura-section">
        <div class="assinatura-grid" style="display: none;">
          <div>
            <label><strong>Supervisor:</strong></label><br>
            <input type="text" id="supervisor_readonly" readonly placeholder="Preenchido automaticamente">
          </div>
          <div>
            <label><strong>Plant√£o:</strong></label><br>
            <input type="text" id="plantao_readonly" readonly placeholder="Preenchido automaticamente">
          </div>
        </div>
        <div class="linha-assinatura">Assinatura</div>
      </div>

      <div style="display: flex; gap: 10px; justify-content: center; margin: 16px auto 8px auto; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 280px; max-width: 50%; border: 2px solid #0070c0; border-radius: 8px; padding: 10px; background: #f0f8ff;">
          <div style="font-weight: bold; color: #004080; margin-bottom: 8px; text-align: center; font-size: 0.95rem;">Templates de Plant√£o (Local)</div>
          <div style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;">
            <button type="button" class="print-btn" style="margin: 0; padding: 6px 10px; font-size: 0.88rem; flex: 1; min-width: 110px;" onclick="saveTemplate()">Salvar Template</button>
            <button type="button" class="print-btn" style="margin: 0; padding: 6px 10px; font-size: 0.88rem; flex: 1; min-width: 110px; background: #0070c0;" onclick="loadTemplate()">Carregar Template</button>
            <button type="button" class="print-btn" style="margin: 0; padding: 6px 10px; font-size: 0.88rem; flex: 1; min-width: 110px; background: #c04000;" onclick="clearTemplate()">Limpar Template</button>
          </div>
        </div>
        <div style="flex: 1; min-width: 280px; max-width: 50%; border: 2px solid #28a745; border-radius: 8px; padding: 10px; background: #f0fff4;">
          <div style="font-weight: bold; color: #1e7e34; margin-bottom: 8px; text-align: center; font-size: 0.95rem;">‚òÅÔ∏è Escalas no GitHub</div>
          <div style="display: flex; gap: 6px; flex-wrap: wrap; justify-content: center;">
            <button type="button" class="print-btn" style="margin: 0; padding: 6px 10px; font-size: 0.88rem; flex: 1; min-width: 110px; background: #28a745;" onclick="saveToGitHub()">üíæ Salvar no GitHub</button>
            <button type="button" class="print-btn" style="margin: 0; padding: 6px 10px; font-size: 0.88rem; flex: 1; min-width: 110px; background: #17a2b8;" onclick="loadFromGitHub()">üì• Carregar do GitHub</button>
            <button type="button" class="print-btn" style="margin: 0; padding: 6px 10px; font-size: 0.88rem; flex: 1; min-width: 110px; background: #6c757d;" onclick="listGitHubScales()">üìã Ver Todas Escalas</button>
          </div>
        </div>
      </div>
      <button type="button" class="print-btn" onclick="preparePrint()">üñ®Ô∏è Gerar PDF / Imprimir</button>
    </form>
  </div>

  <script>
    // ========== CONFIGURA√á√ÉO DO GITHUB ==========
    const GITHUB_CONFIG_KEY = 'demutran_github_config';

    class GitHubAPI {
      constructor() {
        this.loadConfig();
      }

      loadConfig() {
        const saved = localStorage.getItem(GITHUB_CONFIG_KEY);
        if (saved) {
          const config = JSON.parse(saved);
          this.token = config.token;
          this.owner = config.owner;
          this.repo = config.repo;
          this.configured = true;
          
          // Oculta o painel de configura√ß√£o se j√° estiver configurado
          document.getElementById('githubConfig').style.display = 'none';
        } else {
          this.configured = false;
        }
      }

      saveConfig(token, owner, repo) {
        this.token = token;
        this.owner = owner;
        this.repo = repo;
        this.configured = true;
        
        localStorage.setItem(GITHUB_CONFIG_KEY, JSON.stringify({
          token: token,
          owner: owner,
          repo: repo
        }));
      }

      async testConnection() {
        try {
          const response = await fetch(`https://api.github.com/repos/${this.owner}/${this.repo}`, {
            headers: {
              'Authorization': `token ${this.token}`,
              'Accept': 'application/vnd.github.v3+json'
            }
          });

          if (response.ok) {
            return { success: true, message: 'Conex√£o estabelecida com sucesso!' };
          } else {
            const error = await response.json();
            return { success: false, message: `Erro: ${error.message}` };
          }
        } catch (error) {
          return { success: false, message: `Erro de conex√£o: ${error.message}` };
        }
      }

      async getFile(path) {
        try {
          const response = await fetch(
            `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${path}`,
            {
              headers: {
                'Authorization': `token ${this.token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            }
          );

          if (response.ok) {
            const data = await response.json();
            const content = atob(data.content);
            return { success: true, data: JSON.parse(content), sha: data.sha };
          } else if (response.status === 404) {
            return { success: false, notFound: true };
          } else {
            return { success: false, message: 'Erro ao buscar arquivo' };
          }
        } catch (error) {
          return { success: false, message: error.message };
        }
      }

      async saveFile(path, content, message, sha = null) {
        try {
          const body = {
            message: message,
            content: btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2)))),
            branch: 'main'
          };

          if (sha) {
            body.sha = sha;
          }

          const response = await fetch(
            `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${path}`,
            {
              method: 'PUT',
              headers: {
                'Authorization': `token ${this.token}`,
                'Accept': 'application/vnd.github.v3+json',
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(body)
            }
          );

          if (response.ok) {
            return { success: true };
          } else {
            const error = await response.json();
            return { success: false, message: error.message };
          }
        } catch (error) {
          return { success: false, message: error.message };
        }
      }

      async listFiles(path) {
        try {
          const response = await fetch(
            `https://api.github.com/repos/${this.owner}/${this.repo}/contents/${path}`,
            {
              headers: {
                'Authorization': `token ${this.token}`,
                'Accept': 'application/vnd.github.v3+json'
              }
            }
          );

          if (response.ok) {
            const data = await response.json();
            return { success: true, files: data };
          } else if (response.status === 404) {
            return { success: true, files: [] };
          } else {
            return { success: false, message: 'Erro ao listar arquivos' };
          }
        } catch (error) {
          return { success: false, message: error.message };
        }
      }
    }

    const githubAPI = new GitHubAPI();

    function saveGitHubConfig() {
      const token = document.getElementById('githubToken').value.trim();
      const owner = document.getElementById('githubOwner').value.trim();
      const repo = document.getElementById('githubRepo').value.trim();

      if (!token || !owner || !repo) {
        showStatus('error', 'Por favor, preencha todos os campos!');
        return;
      }

      githubAPI.saveConfig(token, owner, repo);
      showStatus('success', '‚úÖ Configura√ß√£o salva! Testando conex√£o...');

      setTimeout(() => {
        testGitHubConnection();
      }, 1000);
    }

    async function testGitHubConnection() {
      if (!githubAPI.configured) {
        showStatus('error', 'Configure o GitHub primeiro!');
        return;
      }

      showLoading(true);
      const result = await githubAPI.testConnection();
      showLoading(false);

      if (result.success) {
        showStatus('success', `‚úÖ ${result.message}`);
        setTimeout(() => {
          document.getElementById('githubConfig').style.display = 'none';
        }, 2000);
      } else {
        showStatus('error', `‚ùå ${result.message}`);
      }
    }

    function showStatus(type, message) {
      const status = document.getElementById('configStatus');
      status.className = `status ${type}`;
      status.textContent = message;
    }

    function showLoading(show) {
      document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    }

    // ========== FUN√á√ïES DE SALVAMENTO/CARREGAMENTO DO GITHUB ==========

    async function saveToGitHub() {
      if (!githubAPI.configured) {
        alert('‚ö†Ô∏è Configure o GitHub primeiro!');
        document.getElementById('githubConfig').style.display = 'block';
        return;
      }

      const data = document.getElementById('data').value;
      const plantao = document.getElementById('tipoOperacao').value;

      if (!data || !plantao) {
        alert('Por favor, preencha a Data e o Plant√£o antes de salvar!');
        return;
      }

      const escalaData = collectFormData();
      
      // Estrutura: escalas/plantao-a/2025-11/2025-11-20.json
      const plantaoSlug = plantao.toLowerCase().replace(/\s+/g, '-');
      const [year, month] = data.split('-');
      const path = `escalas/${plantaoSlug}/${year}-${month}/${data}.json`;

      showLoading(true);

      // Verifica se o arquivo j√° existe para pegar o SHA
      const existing = await githubAPI.getFile(path);
      const sha = existing.success ? existing.sha : null;

      const result = await githubAPI.saveFile(
        path,
        escalaData,
        `Atualiza√ß√£o da escala - ${plantao} - ${formatDateBR(data)}`,
        sha
      );

      showLoading(false);

      if (result.success) {
        alert(`‚úÖ Escala salva com sucesso no GitHub!\n\nüìÅ Arquivo: ${path}\nüìÖ Data: ${formatDateBR(data)}\nüëÆ Plant√£o: ${plantao}`);
      } else {
        alert(`‚ùå Erro ao salvar no GitHub:\n${result.message}`);
      }
    }

    async function loadFromGitHub() {
      if (!githubAPI.configured) {
        alert('‚ö†Ô∏è Configure o GitHub primeiro!');
        document.getElementById('githubConfig').style.display = 'block';
        return;
      }

      const data = document.getElementById('data').value;
      const plantao = document.getElementById('tipoOperacao').value;

      if (!data || !plantao) {
        alert('Por favor, selecione a Data e o Plant√£o para carregar!');
        return;
      }

      const plantaoSlug = plantao.toLowerCase().replace(/\s+/g, '-');
      const [year, month] = data.split('-');
      const path = `escalas/${plantaoSlug}/${year}-${month}/${data}.json`;

      showLoading(true);
      const result = await githubAPI.getFile(path);
      showLoading(false);

      if (result.success) {
        loadFormData(result.data);
        alert(`‚úÖ Escala carregada com sucesso!\n\nüìÖ Data: ${formatDateBR(data)}\nüëÆ Plant√£o: ${plantao}`);
      } else if (result.notFound) {
        alert(`‚ÑπÔ∏è Nenhuma escala encontrada para:\n\nüìÖ Data: ${formatDateBR(data)}\nüëÆ Plant√£o: ${plantao}`);
      } else {
        alert(`‚ùå Erro ao carregar: ${result.message}`);
      }
    }

    async function listGitHubScales() {
      if (!githubAPI.configured) {
        alert('‚ö†Ô∏è Configure o GitHub primeiro!');
        document.getElementById('githubConfig').style.display = 'block';
        return;
      }

      showLoading(true);

      // Lista todas as pastas de plant√µes
      const plantoes = ['plantao-a', 'plantao-b', 'plantao-c', 'plantao-d'];
      const allScales = [];

      for (const plantao of plantoes) {
        const result = await githubAPI.listFiles(`escalas/${plantao}`);
        
        if (result.success && result.files.length > 0) {
          // Para cada pasta de m√™s
          for (const monthFolder of result.files) {
            if (monthFolder.type === 'dir') {
              const filesResult = await githubAPI.listFiles(monthFolder.path);
              
              if (filesResult.success) {
                for (const file of filesResult.files) {
                  if (file.name.endsWith('.json')) {
                    const dateMatch = file.name.match(/(\d{4}-\d{2}-\d{2})/);
                    if (dateMatch) {
                      allScales.push({
                        date: dateMatch[1],
                        plantao: plantao,
                        path: file.path
                      });
                    }
                  }
                }
              }
            }
          }
        }
      }

      showLoading(false);

      if (allScales.length === 0) {
        alert('‚ÑπÔ∏è Nenhuma escala encontrada no GitHub.');
        return;
      }

      // Ordena por data (mais recente primeiro)
      allScales.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Monta o HTML da lista
      let html = '<div style="max-height: 500px; overflow-y: auto;">';
      html += '<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">';
      html += '<thead><tr style="background: #eef0ff; position: sticky; top: 0;">';
      html += '<th style="padding: 8px; border: 1px solid #ddd;">Data</th>';
      html += '<th style="padding: 8px; border: 1px solid #ddd;">Plant√£o</th>';
      html += '<th style="padding: 8px; border: 1px solid #ddd;">A√ß√µes</th>';
      html += '</tr></thead><tbody>';

      allScales.forEach(scale => {
        const plantaoNome = scale.plantao.replace('plantao-', 'Plant√£o ').toUpperCase();
        html += '<tr>';
        html += `<td style="padding: 6px; border: 1px solid #ddd;">${formatDateBR(scale.date)}</td>`;
        html += `<td style="padding: 6px; border: 1px solid #ddd;">${plantaoNome}</td>`;
        html += `<td style="padding: 6px; border: 1px solid #ddd;">`;
        html += `<button onclick="loadScaleFromList('${scale.date}', '${scale.plantao}')" style="padding: 4px 8px; background: #0070c0; color: white; border: none; border-radius: 4px; cursor: pointer;">üì• Carregar</button>`;
        html += '</td></tr>';
      });

      html += '</tbody></table></div>';

      showModal('üìã Escalas Salvas no GitHub', html);
    }

    async function loadScaleFromList(date, plantaoSlug) {
      const plantaoMap = {
        'plantao-a': 'Plant√£o A',
        'plantao-b': 'Plant√£o B',
        'plantao-c': 'Plant√£o C',
        'plantao-d': 'Plant√£o D'
      };

      document.getElementById('data').value = date;
      document.getElementById('tipoOperacao').value = plantaoMap[plantaoSlug];
      
      closeModal();
      await loadFromGitHub();
    }

    // ========== COLETA E CARREGAMENTO DE DADOS ==========

    function collectFormData() {
      const data = {
        data: document.getElementById('data').value,
        diaSemana: document.getElementById('diaSemana').value,
        plantao: document.getElementById('tipoOperacao').value,
        supervisor: document.getElementById('supervisor').value,
        observacoes: document.getElementById('observacoes').value,
        turnos: [],
        turnosVisibility: {},
        savedAt: new Date().toISOString()
      };

      // Coleta dados de cada turno
      turnos.forEach((turno, idx) => {
        const tableBody = document.querySelector(`#table-${idx} tbody`);
        const rows = [];

        Array.from(tableBody.querySelectorAll('tr')).forEach(tr => {
          const viatura = tr.querySelector(`input[name="viatura-${idx}[]"]`).value;
          const agentes = tr.querySelector(`textarea[name="agentes-${idx}[]"]`).value;
          const horario = tr.querySelector(`input[name="horario-${idx}[]"]`).value;
          const os = tr.querySelector(`textarea[name="os-${idx}[]"]`).value;

          if (viatura.trim() || agentes.trim()) {
            rows.push({ viatura, agentes, horario, os });
          }
        });

        data.turnos.push({ idx, rows });
      });

      // Estado dos checkboxes
      document.querySelectorAll('.turno-toggle').forEach(toggle => {
        const idx = toggle.getAttribute('data-idx');
        data.turnosVisibility[idx] = toggle.checked;
      });

      return data;
    }

    function loadFormData(data) {
      document.getElementById('data').value = data.data;
      document.getElementById('diaSemana').value = data.diaSemana;
      document.getElementById('tipoOperacao').value = data.plantao;
      document.getElementById('supervisor').value = data.supervisor;
      document.getElementById('observacoes').value = data.observacoes;

      // Carrega dados de cada turno
      data.turnos.forEach(turnoData => {
        const idx = turnoData.idx;
        const tableBody = document.querySelector(`#table-${idx} tbody`);
        tableBody.innerHTML = '';

        if (turnoData.rows.length === 0) {
          tableBody.insertAdjacentHTML('beforeend', createRow(idx));
        } else {
          turnoData.rows.forEach(rowData => {
            tableBody.insertAdjacentHTML('beforeend', createRow(idx));
            const newRow = tableBody.lastElementChild;
            newRow.querySelector(`input[name="viatura-${idx}[]"]`).value = rowData.viatura;
            newRow.querySelector(`textarea[name="agentes-${idx}[]"]`).value = rowData.agentes;
            newRow.querySelector(`input[name="horario-${idx}[]"]`).value = rowData.horario;
            newRow.querySelector(`textarea[name="os-${idx}[]"]`).value = rowData.os;
          });
        }
      });

      // Restaura visibilidade dos turnos
      if (data.turnosVisibility) {
        document.querySelectorAll('.turno-toggle').forEach(toggle => {
          const idx = toggle.getAttribute('data-idx');
          if (data.turnosVisibility[idx] !== undefined) {
            toggle.checked = data.turnosVisibility[idx];
            const card = document.getElementById('turno-' + idx);
            card.style.display = toggle.checked ? 'block' : 'none';
          }
        });
      }

      initAutoGrow();
      syncRodape();
    }

    // ========== RESTO DO C√ìDIGO ORIGINAL ==========

    const turnos = [
      { nome: "12x36 - 6h √†s 18h" },
      { nome: "12x36 - 8h √†s 20h" },
      { nome: "12x36 - 10h √†s 22h" },
      { nome: "12x36 - 18h √†s 06h" },
      { nome: "12x36 - 19h √†s 07h" },
      { nome: "5x2 - 8h √†s 17h" },
      { nome: "5x2 - 6h √†s 13h" }
    ];

    function createTurno

</body>
</html>
